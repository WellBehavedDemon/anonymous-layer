import CoordinationPackets from './index.mjs';

import { expect } from 'chai';

import {
    LENGTH_COORDINATION_HEADER,
    LENGTH_KEY_SYMMETRIC,

    MODULUS_PACKET_CHECKSUM,

    OFFSET_CHECKSUM,
    OFFSET_COORDINATION_TYPE,

    OFFSET_KEY_DECRYPTION,

    OFFSET_LENGTH_NEXT,
    OFFSET_LENGTH_REAL,

    REPLY_TYPE_IPV6_UDP,

    TYPE_COORDINATION_ANNOUNCE_PEER_IPV6_WEBSOCKET,
    TYPE_COORDINATION_FORWARD_IPV6_WEBSOCKET,
    TYPE_COORDINATION_REDIRECT_STATIC_IPV6_WEBSOCKET,
} from '../../../constants/index.mjs';

import {
    EXTRACT_UINT16,
    POLYNOMIAL_MODULUS_BUFFER,
} from '../../../utilities/index.mjs';

describe('CoordinationPackets', () => {

    const COMMON_HEADER_CHECK = (buffer, typeA, keyA, lengthRealA, lengthNextA) => {

        // 128-bits symmetric cryptography key
        expect(keyA).to.have.lengthOf(16);

        // 16-bits for any length
        expect(lengthRealA).to.be.lessThan(1 << 16).and.greaterThanOrEqual(0);
        expect(lengthNextA).to.be.lessThan(1 << 16).and.greaterThanOrEqual(0);

        const typeB = buffer[OFFSET_COORDINATION_TYPE];
        expect(typeA).to.equal(typeB);

        const lengthRealB = EXTRACT_UINT16(buffer, OFFSET_LENGTH_REAL);
        const lengthNextB = EXTRACT_UINT16(buffer, OFFSET_LENGTH_NEXT);
        expect(lengthRealA).to.equal(lengthRealB);
        expect(lengthNextA).to.equal(lengthNextB);

        const keyB = buffer.subarray(
            OFFSET_KEY_DECRYPTION,
            (OFFSET_KEY_DECRYPTION + LENGTH_KEY_SYMMETRIC) | 0,
        );

        let index = 0;
        while (index < LENGTH_KEY_SYMMETRIC) {

            const keyDataA = keyA[index];
            const keyDataB = keyB[index];
            expect(keyDataA).to.equal(keyDataB);

            index = (index + 1) | 0;

        }

        const checksumA = EXTRACT_UINT16(buffer, OFFSET_CHECKSUM);

        const checksumB = POLYNOMIAL_MODULUS_BUFFER(
            buffer,
            2, // offset where the dividend octets start
            LENGTH_COORDINATION_HEADER,
            MODULUS_PACKET_CHECKSUM,
        );

        expect(checksumA).to.equal(checksumB);

    };

    const TEST_CASES_A = Object.freeze([
        {
            text: {
                type: TYPE_COORDINATION_FORWARD_IPV6_WEBSOCKET,
                key: new Uint8Array([
                    0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08,
                    0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 0x10,
                ]),
                lengthReal: 0x1A85,
                lengthNext: 0x351D,
                destination: Object.freeze({
                    host: '::1',
                    port: 11412, // 0x2C94
                }),
            },
            binary: new Uint8Array([
                0xBF, 0x41, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x2C, 0x94, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x1A, 0x85, 0x35, 0x1D,
                0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08,
                0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 0x10,
            ]),
        },
        {
            text: {
                type: TYPE_COORDINATION_FORWARD_IPV6_WEBSOCKET,
                key: new Uint8Array([
                    0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18,
                    0x19, 0x1A, 0x1B, 0x1C, 0x1D, 0x1E, 0x1F, 0x20,
                ]),
                lengthReal: 0x0123,
                lengthNext: 0x0456,
                destination: Object.freeze({
                    host: '2804:187c:81cb:6800:31b7:9570:6f8f:a3b6',
                    port: 11412, // 0x2C94
                }),
            },
            binary: new Uint8Array([
                0x02, 0x44, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x2C, 0x94, 0x00, 0x00,
                0x28, 0x04, 0x18, 0x7C, 0x81, 0xCB, 0x68, 0x00,
                0x31, 0xB7, 0x95, 0x70, 0x6F, 0x8F, 0xA3, 0xB6,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x01, 0x23, 0x04, 0x56,
                0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18,
                0x19, 0x1A, 0x1B, 0x1C, 0x1D, 0x1E, 0x1F, 0x20,
            ]),
        },
        {
            text: {
                type: TYPE_COORDINATION_REDIRECT_STATIC_IPV6_WEBSOCKET,
                key: new Uint8Array([
                    0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48,
                    0x49, 0x4A, 0x4B, 0x4C, 0x4D, 0x4E, 0x4F, 0x50,
                ]),
                lengthReal: 0x0351,
                lengthNext: 0x0852,
                destination: Object.freeze({
                    host: '2804::a3b6',
                    port: 11412, // 0x2C94
                }),
                reply: Object.freeze({
                    type: REPLY_TYPE_IPV6_UDP,
                    destination: Object.freeze({
                        host: '187c::6f8f',
                        port: 12345, // 0x3039
                    }),
                }),
                sharedSecretDecryption: new Uint8Array([
                    0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28,
                    0x29, 0x2A, 0x2B, 0x2C, 0x2D, 0x2E, 0x2F, 0x30,
                ]),
                remainderDecryption: new Uint8Array([
                    0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38,
                ]),
                sharedSecretEncryption: new Uint8Array([
                    0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48,
                    0x49, 0x4A, 0x4B, 0x4C, 0x4D, 0x4E, 0x4F, 0x50,
                ]),
                remainderEncryption: new Uint8Array([
                    0x51, 0x52, 0x53, 0x54, 0x55, 0x56, 0x57, 0x58,
                ]),
                shiftTimeIdle: 15,      // (1 << 15) milliseconds, around 32 seconds
                shiftTimeTotal: 20,     // (1 << 20) milliseconds, around 17 minutes
                shiftDataAverage: 12,   // (1 << 12) octets per second, exactly 4 KiB/s
                shiftDataTotal: 22,     // (1 << 22) octets, exactly 4 MiB
            },
            binary: new Uint8Array([
                0x78, 0x5E, 0x06, 0x03, 0x0F, 0x14, 0x0C, 0x16,
                0x00, 0x00, 0x00, 0x00, 0x2C, 0x94, 0x30, 0x39,
                0x28, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xA3, 0xB6,
                0x18, 0x7C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x6F, 0x8F,
                0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28,
                0x29, 0x2A, 0x2B, 0x2C, 0x2D, 0x2E, 0x2F, 0x30,
                0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48,
                0x49, 0x4A, 0x4B, 0x4C, 0x4D, 0x4E, 0x4F, 0x50,
                0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38,
                0x51, 0x52, 0x53, 0x54, 0x55, 0x56, 0x57, 0x58,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x03, 0x51, 0x08, 0x52,
                0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48,
                0x49, 0x4A, 0x4B, 0x4C, 0x4D, 0x4E, 0x4F, 0x50,
            ]),
        },
        {
            text: {
                type: TYPE_COORDINATION_ANNOUNCE_PEER_IPV6_WEBSOCKET,
                key: new Uint8Array([
                    0x51, 0x52, 0x53, 0x54, 0x55, 0x56, 0x57, 0x58,
                    0x59, 0x5A, 0x5B, 0x5C, 0x5D, 0x5E, 0x5F, 0x60,
                ]),
                lengthReal: 0x0100,
                lengthNext: 0x0000,
                destination: Object.freeze({
                    host: '81cb::6800',
                    port: 11412, // 0x2C94
                }),
            },
            binary: new Uint8Array([
                0xD9, 0xA7, 0x0E, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x2C, 0x94, 0x00, 0x00,
                0x81, 0xCB, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x68, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
                0x51, 0x52, 0x53, 0x54, 0x55, 0x56, 0x57, 0x58,
                0x59, 0x5A, 0x5B, 0x5C, 0x5D, 0x5E, 0x5F, 0x60,
            ]),
        },
    ]);

    it('should format text objects into binary packets', () => {

        for (const request of TEST_CASES_A) {

            const { text, binary: binaryA } = request;

            const {
                type: typeA,
                key: keyA,
                lengthReal: lengthRealA,
                lengthNext: lengthNextA,
            } = text;

            const binaryB = new Uint8Array(LENGTH_COORDINATION_HEADER);

            CoordinationPackets.format(text, binaryB);

            COMMON_HEADER_CHECK(
                binaryB,
                typeA,
                keyA,
                lengthRealA,
                lengthNextA,
            );

            let index = 0;
            while (index < LENGTH_COORDINATION_HEADER) {

                expect(binaryA[index]).to.equal(binaryB[index]);
                index = (index + 1) | 0;

            }

        }

    });

});
